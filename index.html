<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FichApp</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}

.card{
  background:white;
  padding:25px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  width:350px;
}

h2{
  text-align:center;
}

input, select{
  width:100%;
  padding:8px;
  margin-top:10px;
  border-radius:5px;
  border:1px solid #ccc;
}

button{
  width:100%;
  padding:10px;
  margin-top:15px;
  border:none;
  border-radius:5px;
  background:#007bff;
  color:white;
  cursor:pointer;
}

button:hover{
  background:#0056b3;
}

.hidden{
  display:none;
}

.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#28a745;
  color:white;
  padding:10px 15px;
  border-radius:5px;
  display:none;
}
</style>
</head>

<body>

<div class="card" id="loginCard">
  <h2>Ingreso</h2>
  <input type="text" id="legajo" placeholder="Legajo">
  <button onclick="validarLegajo()">Validar</button>
</div>

<div class="card hidden" id="formCard">
  <h2 id="nombreEmpleado"></h2>

  <select id="tipoNovedad" onchange="mostrarCampos()">
    <option value="">Seleccionar novedad</option>
    <option value="Ficha Manual">Ficha Manual</option>
    <option value="Cambio de Franco">Cambio de Franco</option>
    <option value="Retiro Anticipado">Retiro Anticipado</option>
    <option value="Ausencia">Ausencia</option>
  </select>

  <!-- Subtipo Ficha Manual -->
  <div id="subTipoFicha" class="hidden">
    <select id="tipoFichaManual" onchange="mostrarCamposFichaManual()">
      <option value="">Seleccionar tipo de ficha</option>
      <option value="Entrada">Entrada</option>
      <option value="Salida">Salida</option>
      <option value="Ambas">Entrada y Salida</option>
    </select>
  </div>

  <!-- Hora Entrada -->
  <div id="campoEntrada" class="hidden">
    <input type="time" id="horaEntrada">
  </div>

  <!-- Hora Salida -->
  <div id="campoSalida" class="hidden">
    <input type="time" id="horaSalida">
  </div>

  <!-- Motivo -->
  <div id="campoMotivo" class="hidden">
    <input type="text" id="motivo" placeholder="Motivo">
  </div>

  <button onclick="enviar()">Guardar</button>
</div>

<div class="toast" id="toast">Registro guardado correctamente</div>

<script>

const API_URL = "https://script.google.com/macros/s/AKfycbxg4RTDl7ucjUoM3S-GwbrUFRqBfrbFYY8keTnWzU47nXY1Rt4cXpUXBt8ibFw3M0-SLg/exec";

let empleadoActual = null;

/* ===========================
   VALIDAR LEGAJO
=========================== */
function validarLegajo(){
  const legajo = document.getElementById("legajo").value.trim();
  if(!legajo) return alert("Ingrese legajo");

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"validar",
      legajo:legajo
    })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      empleadoActual = data;
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("formCard").classList.remove("hidden");
      document.getElementById("nombreEmpleado").innerText =
        data.nombre + " (" + data.legajo + ")";
    }else{
      alert("Legajo no encontrado");
    }
  })
  .catch(()=> alert("Error conexión"));
}

/* ===========================
   MOSTRAR CAMPOS PRINCIPAL
=========================== */
function mostrarCampos(){
  ocultarTodo();

  const tipo = document.getElementById("tipoNovedad").value;

  if(tipo === "Ficha Manual"){
    document.getElementById("subTipoFicha").classList.remove("hidden");
  }

  if(tipo === "Cambio de Franco"){
    document.getElementById("campoMotivo").classList.remove("hidden");
  }

  if(tipo === "Retiro Anticipado"){
    document.getElementById("campoSalida").classList.remove("hidden");
    document.getElementById("campoMotivo").classList.remove("hidden");
  }

  if(tipo === "Ausencia"){
    document.getElementById("campoMotivo").classList.remove("hidden");
  }
}

/* ===========================
   MOSTRAR CAMPOS FICHA MANUAL
=========================== */
function mostrarCamposFichaManual(){
  ocultarCamposHoras();

  const subTipo = document.getElementById("tipoFichaManual").value;

  if(subTipo === "Entrada"){
    document.getElementById("campoEntrada").classList.remove("hidden");
  }

  if(subTipo === "Salida"){
    document.getElementById("campoSalida").classList.remove("hidden");
  }

  if(subTipo === "Ambas"){
    document.getElementById("campoEntrada").classList.remove("hidden");
    document.getElementById("campoSalida").classList.remove("hidden");
  }
}

/* ===========================
   ENVIAR
=========================== */
function enviar(){
  const tipo = document.getElementById("tipoNovedad").value;
  const subTipo = document.getElementById("tipoFichaManual").value;
  const horaEntrada = document.getElementById("horaEntrada").value;
  const horaSalida = document.getElementById("horaSalida").value;
  const motivo = document.getElementById("motivo").value;

  if(!tipo) return alert("Seleccione novedad");

  if(tipo === "Ficha Manual"){
    if(!subTipo) return alert("Seleccione tipo de ficha");

    if(subTipo === "Entrada" && !horaEntrada)
      return alert("Debe ingresar hora de entrada");

    if(subTipo === "Salida" && !horaSalida)
      return alert("Debe ingresar hora de salida");

    if(subTipo === "Ambas" && (!horaEntrada || !horaSalida))
      return alert("Debe ingresar ambas horas");
  }

  if(tipo === "Retiro Anticipado"){
    if(!horaSalida || !motivo)
      return alert("Complete hora de salida y motivo");
  }

  if(tipo === "Cambio de Franco" && !motivo)
    return alert("Debe ingresar motivo");

  if(tipo === "Ausencia" && !motivo)
    return alert("Debe ingresar motivo");

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"guardar",
      legajo:empleadoActual.legajo,
      nombre:empleadoActual.nombre,
      tipo: tipo === "Ficha Manual"
            ? "Ficha Manual - " + subTipo
            : tipo,
      horaEntrada:horaEntrada,
      horaSalida:horaSalida,
      motivo:motivo
    })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      mostrarToast();
      resetForm();
    }else{
      alert("Error al guardar");
    }
  })
  .catch(()=> alert("Error conexión"));
}

/* ===========================
   UTILIDADES
=========================== */
function ocultarTodo(){
  document.getElementById("subTipoFicha").classList.add("hidden");
  document.getElementById("campoEntrada").classList.add("hidden");
  document.getElementById("campoSalida").classList.add("hidden");
  document.getElementById("campoMotivo").classList.add("hidden");
}

function ocultarCamposHoras(){
  document.getElementById("campoEntrada").classList.add("hidden");
  document.getElementById("campoSalida").classList.add("hidden");
}

function mostrarToast(){
  const toast = document.getElementById("toast");
  toast.style.display="block";
  setTimeout(()=> toast.style.display="none",3000);
}

function resetForm(){
  document.getElementById("tipoNovedad").value="";
  document.getElementById("tipoFichaManual").value="";
  document.getElementById("horaEntrada").value="";
  document.getElementById("horaSalida").value="";
  document.getElementById("motivo").value="";
  ocultarTodo();
}

</script>
</body>
</html>